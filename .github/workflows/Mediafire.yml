name: Upload URL to MediaFire

on:
  workflow_dispatch:
    inputs:
      file_url:
        description: 'ÐŸÑ€ÑÐ¼Ð°Ñ ÑÑÑ‹Ð»ÐºÐ° Ð½Ð° Ñ„Ð°Ð¹Ð» Ð´Ð»Ñ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸'
        required: true
        type: string
      filename:
        description: 'Ð˜Ð¼Ñ Ñ„Ð°Ð¹Ð»Ð° Ð² MediaFire (Ð¾Ð¿Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾)'
        required: false
        type: string
      folder_key:
        description: 'ÐšÐ»ÑŽÑ‡ Ð¿Ð°Ð¿ÐºÐ¸ Ð² MediaFire (Ð¾Ð¿Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾)'
        required: false
        type: string
        default: ''

env:
  # Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ Ð¿ÑƒÐ±Ð»Ð¸Ñ‡Ð½Ñ‹Ðµ App ID/API Key Ð¾Ñ‚ Ð´ÐµÑÐºÑ‚Ð¾Ð¿Ð½Ð¾Ð³Ð¾ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ MediaFire
  MEDIAFIRE_APP_ID: "22870"
  MEDIAFIRE_API_KEY: "h6k9k0v8a7v1e2d6"

jobs:
  upload-to-mediafire:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v5
      
    - name: Setup Python
      uses: actions/setup-python@v6
      with:
        python-version: '3.10'
        
    - name: Install dependencies
      run: |
        pip install requests
        
    - name: Download file from URL
      id: download
      run: |
        # Ð¡ÐºÐ°Ñ‡Ð¸Ð²Ð°ÐµÐ¼ Ñ„Ð°Ð¹Ð» Ð¸Ð· Ð¿Ñ€ÐµÐ´Ð¾ÑÑ‚Ð°Ð²Ð»ÐµÐ½Ð½Ð¾Ð¹ ÑÑÑ‹Ð»ÐºÐ¸
        URL="${{ github.event.inputs.file_url }}"
        
        # Ð•ÑÐ»Ð¸ Ð¸Ð¼Ñ Ñ„Ð°Ð¹Ð»Ð° Ð½Ðµ ÑƒÐºÐ°Ð·Ð°Ð½Ð¾, Ð¸Ð·Ð²Ð»ÐµÐºÐ°ÐµÐ¼ ÐµÐ³Ð¾ Ð¸Ð· URL
        if [ -z "${{ github.event.inputs.filename }}" ]; then
          FILENAME=$(basename "$URL")
          # Ð£Ð´Ð°Ð»ÑÐµÐ¼ Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ñ‹ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ° Ð¸Ð· Ð¸Ð¼ÐµÐ½Ð¸ Ñ„Ð°Ð¹Ð»Ð°
          FILENAME=$(echo "$FILENAME" | cut -d'?' -f1)
        else
          FILENAME="${{ github.event.inputs.filename }}"
        fi
        
        echo "Downloading $FILENAME from $URL..."
        
        # Ð¡ÐºÐ°Ñ‡Ð¸Ð²Ð°ÐµÐ¼ Ñ„Ð°Ð¹Ð» Ñ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¾Ð¹ Ð²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ñ‹Ñ… Ð¾ÑˆÐ¸Ð±Ð¾Ðº
        if wget -O "$FILENAME" "$URL"; then
          FILESIZE=$(stat -c%s "$FILENAME")
          echo "Downloaded $FILENAME ($FILESIZE bytes)"
          
          echo "file_path=$FILENAME" >> $GITHUB_OUTPUT
          echo "file_name=$FILENAME" >> $GITHUB_OUTPUT
          echo "file_size=$FILESIZE" >> $GITHUB_OUTPUT
        else
          echo "Failed to download file"
          exit 1
        fi
        
    - name: Upload to MediaFire
      id: upload
      env:
        MEDIAFIRE_EMAIL: ${{ secrets.MEDIAFIRE_EMAIL }}
        MEDIAFIRE_PASSWORD: ${{ secrets.MEDIAFIRE_PASSWORD }}
        MEDIAFIRE_FOLDER_KEY: ${{ github.event.inputs.folder_key }}
      run: |
        python -c "
        import requests
        import os
        import json
        import sys
        from urllib.parse import quote
        
        class MediaFireUploader:
            def __init__(self, app_id, api_key):
                self.base_url = 'https://www.mediafire.com/api/1.4'
                self.app_id = app_id
                self.api_key = api_key
                self.session_token = None
                self.session = requests.Session()
                self.session.headers.update({
                    'User-Agent': 'MediaFire GitHub Actions Uploader/1.0'
                })
            
            def login(self, email, password):
                \"\"\"ÐÐ²Ñ‚Ð¾Ñ€Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð² MediaFire\"\"\"
                print(f'Logging in as {email}...')
                
                params = {
                    'email': email,
                    'password': password,
                    'application_id': self.app_id,
                    'signature': self.api_key,
                    'response_format': 'json',
                    'token_version': 2
                }
                
                try:
                    response = self.session.get(
                        f'{self.base_url}/user/get_session_token.php',
                        params=params,
                        timeout=30
                    )
                    
                    if response.status_code != 200:
                        print(f'HTTP Error: {response.status_code}')
                        return False
                    
                    data = response.json()
                    print(f'Login response: {json.dumps(data, indent=2)}')
                    
                    if data.get('response', {}).get('result') == 'Success':
                        self.session_token = data['response']['session_token']
                        print(f'âœ“ Login successful. Session token: {self.session_token[:20]}...')
                        return True
                    else:
                        error_msg = data.get('response', {}).get('message', 'Unknown error')
                        print(f'âœ— Login failed: {error_msg}')
                        return False
                        
                except Exception as e:
                    print(f'âœ— Login error: {str(e)}')
                    return False
            
            def get_upload_url(self):
                \"\"\"ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ URL Ð´Ð»Ñ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Ñ„Ð°Ð¹Ð»Ð°\"\"\"
                params = {
                    'session_token': self.session_token,
                    'response_format': 'json'
                }
                
                response = self.session.get(
                    f'{self.base_url}/upload/get_upload_url.php',
                    params=params,
                    timeout=30
                )
                
                if response.status_code == 200:
                    data = response.json()
                    if data.get('response', {}).get('result') == 'Success':
                        return data['response']['upload_url']
                
                print(f'Failed to get upload URL: {response.text}')
                return None
            
            def upload_file(self, file_path, folder_key=''):
                \"\"\"Ð—Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚ÑŒ Ñ„Ð°Ð¹Ð» Ð² MediaFire\"\"\"
                filename = os.path.basename(file_path)
                print(f'Uploading {filename} ({os.path.getsize(file_path)} bytes)...')
                
                # 1. ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ URL Ð´Ð»Ñ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸
                upload_url = self.get_upload_url()
                if not upload_url:
                    return None
                
                print(f'Upload URL obtained: {upload_url[:50]}...')
                
                # 2. Ð—Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ Ñ„Ð°Ð¹Ð»
                try:
                    with open(file_path, 'rb') as f:
                        files = {'file': (filename, f)}
                        print('Sending file to upload server...')
                        
                        upload_response = self.session.post(
                            upload_url,
                            files=files,
                            timeout=60
                        )
                        
                        if upload_response.status_code != 200:
                            print(f'Upload failed: {upload_response.status_code}')
                            print(upload_response.text[:200])
                            return None
                        
                        quick_key = upload_response.text.strip()
                        print(f'âœ“ File uploaded. Quick key: {quick_key}')
                        
                        # 3. Ð ÐµÐ³Ð¸ÑÑ‚Ñ€Ð¸Ñ€ÑƒÐµÐ¼ Ñ„Ð°Ð¹Ð»
                        params = {
                            'session_token': self.session_token,
                            'quick_key': quick_key,
                            'filename': filename,
                            'response_format': 'json'
                        }
                        
                        if folder_key:
                            params['folder_key'] = folder_key
                        
                        print('Registering file...')
                        register_response = self.session.get(
                            f'{self.base_url}/upload/instant.php',
                            params=params,
                            timeout=30
                        )
                        
                        if register_response.status_code == 200:
                            data = register_response.json()
                            if data.get('response', {}).get('result') == 'Success':
                                result = data['response']
                                print('âœ“ File registered successfully!')
                                
                                # Ð¤Ð¾Ñ€Ð¼Ð¸Ñ€ÑƒÐµÐ¼ ÑÑÑ‹Ð»ÐºÐ¸
                                quick_key = result.get('quickkey', '')
                                links = {
                                    'quick_key': quick_key,
                                    'direct_link': f'https://www.mediafire.com/file/{quick_key}',
                                    'download_link': f'https://download.mediafire.com/{quick_key}',
                                    'filename': result.get('filename', filename),
                                    'size': result.get('size', '0')
                                }
                                return links
                        
                        print(f'Registration failed: {register_response.text}')
                        return None
                        
                except Exception as e:
                    print(f'âœ— Upload error: {str(e)}')
                    return None
        
        # ===== ÐžÐ¡ÐÐžÐ’ÐÐžÐ™ ÐšÐžÐ” =====
        try:
            # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¸Ð· Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ
            email = os.environ['MEDIAFIRE_EMAIL']
            password = os.environ['MEDIAFIRE_PASSWORD']
            file_path = '${{ steps.download.outputs.file_path }}'
            folder_key = os.environ.get('MEDIAFIRE_FOLDER_KEY', '')
            
            print('=' * 50)
            print('MediaFire Uploader for GitHub Actions')
            print('=' * 50)
            
            # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¸ Ð½Ð°ÑÑ‚Ñ€Ð°Ð¸Ð²Ð°ÐµÐ¼ Ð·Ð°Ð³Ñ€ÑƒÐ·Ñ‡Ð¸Ðº
            uploader = MediaFireUploader(
                app_id='${{ env.MEDIAFIRE_APP_ID }}',
                api_key='${{ env.MEDIAFIRE_API_KEY }}'
            )
            
            # Ð›Ð¾Ð³Ð¸Ð½Ð¸Ð¼ÑÑ
            if not uploader.login(email, password):
                print('::error::Authentication failed')
                sys.exit(1)
            
            # Ð—Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ Ñ„Ð°Ð¹Ð»
            result = uploader.upload_file(file_path, folder_key)
            
            if result:
                print('\\n' + '=' * 50)
                print('UPLOAD SUCCESSFUL!')
                print('=' * 50)
                print(f'File: {result[\"filename\"]}')
                print(f'Size: {result[\"size\"]} bytes')
                print(f'Quick Key: {result[\"quick_key\"]}')
                print(f'Direct Link: {result[\"direct_link\"]}')
                print(f'Download Link: {result[\"download_link\"]}')
                
                # Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ñ‹ Ð´Ð»Ñ ÑÐ»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ñ… ÑˆÐ°Ð³Ð¾Ð²
                with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                    f.write(f'quick_key={result[\"quick_key\"]}\\n')
                    f.write(f'direct_link={result[\"direct_link\"]}\\n')
                    f.write(f'download_link={result[\"download_link\"]}\\n')
                    f.write(f'filename={result[\"filename\"]}\\n')
                    f.write(f'size={result[\"size\"]}\\n')
            else:
                print('::error::Upload failed')
                sys.exit(1)
                
        except KeyError as e:
            print(f'::error::Missing environment variable: {e}')
            sys.exit(1)
        except Exception as e:
            print(f'::error::Unexpected error: {str(e)}')
            sys.exit(1)
        "
        
    - name: Display results
      if: success()
      run: |
        echo " "
        echo "========================================="
        echo "ðŸš€ Upload completed successfully!"
        echo "========================================="
        echo "ðŸ“ File: ${{ steps.upload.outputs.filename }}"
        echo "ðŸ“¦ Size: ${{ steps.upload.outputs.size }} bytes"
        echo "ðŸ”‘ Quick Key: ${{ steps.upload.outputs.quick_key }}"
        echo "ðŸ”— Direct Link: ${{ steps.upload.outputs.direct_link }}"
        echo "â¬‡ï¸  Download Link: ${{ steps.upload.outputs.download_link }}"
        echo "========================================="
        echo " "
        
    - name: Cleanup downloaded file
      if: always()
      run: |
        rm -f "${{ steps.download.outputs.file_path }}" 2>/dev/null || true
        echo "Temporary files cleaned up"
