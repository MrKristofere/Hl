name: Upload file (test)
on:
  workflow_dispatch:
    inputs:
      upl:
        description: 'Comma-separated URLs of files to download'
        required: true
        type: string
      tag:
        description: 'Tag for the release'
        required: true
        type: string
      compress:
        description: 'Compress files before upload (true/false)'
        required: false
        type: boolean

permissions:
  contents: write

jobs:
  upload:
    runs-on: ubuntu-latest
    steps:
      # Update the package list
      - name: Update Package List
        run: |
          sudo apt-get update

      # Cache the aria2 package for faster builds
      - name: Cache APT Packages
        uses: awalsh128/cache-apt-pkgs-action@v1
        with:
          packages: aria2
          version: 1.0

      # Download files in parallel using aria2c
      - name: Download Files
        run: |
          IFS=',' read -r -a urls <<< "${{ inputs.upl }}"
          for url in "${urls[@]}"; do
            aria2c --no-check-certificate -d dloa "$url" &
          done
          wait  # Wait for all background jobs to finish

      # Function to calculate CRC-32 checksum
      - name: Calculate CRC-32 Checksums
        id: crc32_check
        run: |
          cd dloa || exit 1
          for file in *; do
            if [ -f "$file" ]; then
              crc32 "$file" >> ../checksums.txt  # Store checksums in a file
            fi
            
            # If the file is a zip archive, unzip it and calculate CRC-32 for the extracted files
            if [[ "$file" == *.zip ]]; then
              unzip "$file" -d "${file%.zip}" && cd "${file%.zip}" || continue
              for inner_file in *; do
                crc32 "$inner_file" >> ../../checksums.txt  # Store checksums of extracted files
              done
              cd ..  # Go back to the parent directory after processing the archive
            fi
          done

      # Optionally compress files before uploading them to the release
      - name: Compress Files (if selected)
        if: ${{ inputs.compress == 'true' }}
        run: |
          tar -czf dloa.tar.gz -C dloa .

      # Upload Release with calculated checksums and optionally compressed files 
      - name: Upload Release in Parallel
        run: |
          FILES_TO_UPLOAD="dloa/*"
          if [ "${{ inputs.compress }}" == "true" ]; then 
            FILES_TO_UPLOAD="$FILES_TO_UPLOAD dloa.tar.gz"
          fi

          # Upload checksums.txt as well if it exists 
          if [ -f "checksums.txt" ]; then 
            FILES_TO_UPLOAD="$FILES_TO_UPLOAD checksums.txt"
          fi

          for file in $FILES_TO_UPLOAD; do 
            echo "Uploading $file..."
            gh release upload "${{ inputs.tag }}" "$file" --clobber &  # Upload each file in background 
          done 
          
          wait  # Wait for all background uploads to finish
