name: Upload file
on:
  workflow_dispatch:
    inputs:
      upl:
        description: 'URL file'
        required: true
        type: string
      tag:
        description: 'Tag'
        required: true
        type: string
      compress:
        description: 'Compression type (none, zip, tar, 7z)'
        required: false
        type: string
      compression_level:
        description: 'Compression level (1-9)'
        required: false
        type: string
      parallel_downloads:
        description: 'Number of parallel downloads'
        required: true
        type: string

permissions:
  contents: write

jobs:
  upload:
    runs-on: ubuntu-latest
    steps:
      - name: Set up environment
        run: |
          sudo apt-get update
          sudo apt-get install -y aria2 curl jq unzip p7zip-full
          
      - name: Download files
        run: |
          aria2c -d dloa -x 16 -s 16 --continue=true "${{ inputs.upl }}"
          if [ $? -ne 0 ]; then
            echo "Ошибка при скачивании файла"
            exit 1
          fi

      - name: Extract and check CRC32 for downloaded files
        run: |
          if [ -d "dloa" ]; then
            for file in dloa/*; do
              if [ -f "$file" ]; then
                # Проверка CRC32
                FILE_CRC32=$(crc32 "$file")
                echo "CRC32 для файла $file: $FILE_CRC32"
                
                # Разархивация
                if [[ "$file" =~ \.zip$ ]]; then
                  unzip -q "$file" -d dloa/
                elif [[ "$file" =~ \.tar\.gz$ ]]; then
                  tar -xzvf "$file" -C dloa/
                elif [[ "$file" =~ \.tar$ ]]; then
                  tar -xvf "$file" -C dloa/
                elif [[ "$file" =~ \.rar$ ]]; then
                  7z x "$file" -odloa
                fi
              fi
            done
          else
            echo "Ошибка: каталог dloa не существует или пуст."
            exit 1
          fi

      - name: Upload Release
        uses: softprops/action-gh-release@v2
        with:
          files: dloa/*
          tag_name: ${{ inputs.tag }}
        if: success()
