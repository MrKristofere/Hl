name: Download, Compress, Upload, and Lose Our Minds ğŸ’¥ğŸŒªï¸
on:
  workflow_dispatch:
    inputs:
      upl:
        description: 'Comma-separated URLs... or are they just fleeting moments in the void of time? â³ğŸ’­'
        required: true
        type: string
      tag:
        description: 'Tag... but is it really a tag? Or a fleeting memory of something that never existed? ğŸ·ï¸ğŸŒ€'
        required: true
        type: string
      compression:
        description: 'Compression? Are we just squeezing life out of data or trying to save our souls? ğŸ”®'
        required: false
        type: choice
        options:
          - none
          - gzip
          - bzip2
          - xz
          - rar
          - 7z
          - zip
      compress_level:
        description: 'Compression level (1-9) â€” or is it really just about how much of us weâ€™re willing to lose? ğŸ”ª'
        required: false
        type: number
        default: 6
      checksum:
        description: 'CRC32 checksum? But can we really trust anything in this world? ğŸ¤”ğŸ’€'
        required: false
        type: boolean
        default: true

permissions:
  contents: write
  id-token: write
  actions: read

jobs:
  download_compress_and_upload:
    runs-on: ubuntu-latest
    steps:
      - name: Install dependencies... or perhaps just embrace the void? ğŸŒš
        run: |
          sudo apt-get update && sudo apt-get install -y aria2 curl jq unzip p7zip-full rsync zip gzip bzip2 xz-utils python3-pip
          pip3 install crc32c
          echo "The dependencies are installed... or are they? ğŸŒ€ğŸ•³ï¸"

      - name: Download URLs â€” Are we downloading files or are they downloading us? ğŸ”„ğŸ’­
        run: |
          IFS=',' read -r -a urls <<< "${{ inputs.upl }}"
          
          download_commands=()
          for url in "${urls[@]}"; do
            encoded_url=$(echo "$url" | sed 's/,/%2C/g')
            download_commands+=( "aria2c -d dloa -x 16 -s 16 --continue=true --max-connection-per-server=4 '$encoded_url' &" )
          done

          for cmd in "${download_commands[@]}"; do
            eval "$cmd"
          done

          # Wait for all downloads to finish
          wait

      - name: Show me what we've downloaded â€” or is it what the data wanted us to see? ğŸ«£
        run: |
          echo "Files? But are they really files or just fragments of a shattered reality? ğŸ”®"
          ls -lh dloa

      - name: Verify CRC32 â€” Because even numbers can lie to us... or are we the ones lying? ğŸ¤
        if: ${{ inputs.checksum == true }}
        run: |
          echo "Verifying CRC32 checksums... or perhaps verifying our own sanity? ğŸ’€"
    
          # Python script for CRC32 â€” a ritual of trust in a world full of deceiving bits ğŸ‘ï¸
          for file in dloa/*; do
            crc32_value=$(python3 -c "import zlib; print(f'{zlib.crc32(open(\"$file\", \"rb\").read()):08x}')")
            echo "File: $file, CRC32: $crc32_value â€” but do we truly know what a checksum is? ğŸ¤·â€â™‚ï¸"
          done

      - name: Extract files â€” What is extraction? The peeling away of layers, or a journey inward? ğŸ§ 
        run: |
          echo "Extracting... or are we simply deconstructing our existence, one archive at a time? ğŸ”"
          for file in dloa/*; do
            if [[ "$file" == *.tar.gz || "$file" == *.zip || "$file" == *.tar.bz2 || "$file" == *.tar.xz || "$file" == *.rar || "$file" == *.7z ]]; then
              echo "Extracting archive: $file"
              mkdir -p "dloa/$(basename "$file" .${file##*.})"
              case $file in
                *.zip) 7z x "$file" -o"dloa/$(basename "$file" .zip)" ;;
                *.rar) 7z x "$file" -o"dloa/$(basename "$file" .rar)" ;;
                *.7z) 7z x "$file" -o"dloa/$(basename "$file" .7z)" ;;
                *.tar.gz) tar -xvzf "$file" -C "dloa/$(basename "$file" .tar.gz)" ;;
                *.tar.bz2) tar -xvjf "$file" -C "dloa/$(basename "$file" .tar.bz2)" ;;
                *.tar.xz) tar -xvJf "$file" -C "dloa/$(basename "$file" .tar.xz)" ;;
              esac
            elif [[ "$file" == *.iso ]]; then
              echo "ISO detected: $file"
              mkdir -p "dloa/iso_contents"
              isoinfo -i "$file" -l > "dloa/iso_contents/contents.txt"
              cat "dloa/iso_contents/contents.txt"
            fi
          done

      - name: Compress files â€” Or are we just trying to put everything into a tiny box to make it all fit? ğŸ”’ğŸŒ€
        if: ${{ inputs.compression != 'none' }}
        run: |
          echo "Compression... what are we really compressing here? The files, or our feelings? ğŸ’”"
          compression_format="${{ inputs.compression }}"
          compression_level="${{ inputs.compress_level }}"
          
          case $compression_format in
            gzip) tar -cvzf "dloa_compressed.tar.gz" -C dloa . ;;
            bzip2) tar -cvjf "dloa_compressed.tar.bz2" -C dloa . ;;
            xz) tar -cvJf "dloa_compressed.tar.xz" -C dloa . ;;
            rar) 7z a -m0=rar -mx${compression_level} "dloa_compressed.rar" "dloa/*" ;; 
            7z) 7z a -mx${compression_level} "dloa_compressed.7z" "dloa/*" ;;
            zip) 7z a -tzip -mx${compression_level} "dloa_compressed.zip" "dloa/*" ;;  
            *)
              echo "Compression is an illusion... or is it? ğŸ’€ğŸŒ€"
              ;;
          esac
          echo "Compression complete... or was it just the beginning of a deeper descent? ğŸ”®"

      - name: Upload to GitHub Release â€” Is this the end? Or are we releasing ourselves into the unknown? ğŸŒ 
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dloa/*
            dloa_compressed.tar.gz
            dloa_compressed.tar.bz2
            dloa_compressed.tar.xz
            dloa_compressed.rar
            dloa_compressed.7z
            dloa_compressed.zip
          tag_name: ${{ inputs.tag }}
