name: Get pCloud Token (Fixed)

on:
  workflow_dispatch:

jobs:
  get-token:
    runs-on: ubuntu-latest
    
    steps:
    - name: Get pCloud Auth Token
      env:
        PCLOUD_EMAIL: ${{ secrets.PCLOUD_EMAIL }}
        PCLOUD_PASSWORD: ${{ secrets.PCLOUD_PASSWORD }}
      run: |
        echo "=== –ü–û–õ–£–ß–ï–ù–ò–ï –¢–û–ö–ï–ù–ê PCLOUD ==="
        
        # 1. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ (email –≤ hex –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π email!)
        echo "üìß Email (–ø–µ—Ä–≤—ã–µ 15): '${PCLOUD_EMAIL:0:15}...'"
        echo "üìè –î–ª–∏–Ω–∞ email: ${#PCLOUD_EMAIL} —Å–∏–º–≤–æ–ª–æ–≤"
        echo "üîí –î–ª–∏–Ω–∞ –ø–∞—Ä–æ–ª—è: ${#PCLOUD_PASSWORD} —Å–∏–º–≤–æ–ª–æ–≤"
        
        # HEX –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç: jiwoko1707@alexida.com - –í–°–Å –ü–†–ê–í–ò–õ–¨–ù–û!
        echo "‚úÖ Email –≤–µ—Ä–Ω—ã–π (–≤–∏–¥–Ω–æ –∏–∑ hex)"
        
        # 2. –ü–†–ê–í–ò–õ–¨–ù–´–ô —Å–∏–Ω—Ç–∞–∫—Å–∏—Å curl
        echo -e "\nüß™ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å..."
        
        # –°–ø–æ—Å–æ–± 1: –ß–µ—Ä–µ–∑ -d —Å –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ–º –≤—Ä—É—á–Ω—É—é
        ENCODED_EMAIL=$(python3 -c "import urllib.parse; print(urllib.parse.quote('$PCLOUD_EMAIL'))")
        ENCODED_PASSWORD=$(python3 -c "import urllib.parse; print(urllib.parse.quote('$PCLOUD_PASSWORD'))")
        
        echo "–ó–∞–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã–π email: $ENCODED_EMAIL"
        echo "–ó–∞–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–∞—Ä–æ–ª—å: ${ENCODED_PASSWORD:0:10}..."
        
        RESPONSE=$(curl -s -X POST \
          -d "getauth=1&username=$ENCODED_EMAIL&password=$ENCODED_PASSWORD&device=github-actions" \
          https://api.pcloud.com/userinfo)
        
        echo "–û—Ç–≤–µ—Ç: $RESPONSE"
        
        # 3. –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–æ–∫–µ–Ω
        AUTH_TOKEN=$(echo "$RESPONSE" | grep -o '"auth":"[^"]*"' | cut -d'"' -f4)
        
        if [ -n "$AUTH_TOKEN" ]; then
          echo -e "\n‚úÖ –£–°–ü–ï–•! Auth token –ø–æ–ª—É—á–µ–Ω"
          echo "–¢–æ–∫–µ–Ω: ${AUTH_TOKEN:0:20}..."
          
          # 4. –°–æ–∑–¥–∞–µ–º –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã–π —Ç–æ–∫–µ–Ω
          echo -e "\nüîÑ –°–æ–∑–¥–∞–µ–º –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã–π —Ç–æ–∫–µ–Ω (1 –≥–æ–¥)..."
          LONG_RESPONSE=$(curl -s -X POST \
            "https://api.pcloud.com/gettoken?auth=$AUTH_TOKEN&expires=31536000&access=readwrite&appname=GitHub%20Actions")
          
          LONG_TOKEN=$(echo "$LONG_RESPONSE" | grep -o '"token":"[^"]*"' | cut -d'"' -f4)
          
          if [ -n "$LONG_TOKEN" ]; then
            echo -e "\nüéâ –î–û–õ–ì–û–°–†–û–ß–ù–´–ô –¢–û–ö–ï–ù –°–û–ó–î–ê–ù!"
            echo "================================"
            echo "$LONG_TOKEN"
            echo "================================"
            echo ""
            echo "üí° –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –∫–∞–∫ PCLOUD_LONG_TOKEN –≤ GitHub Secrets"
          else
            echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã–π —Ç–æ–∫–µ–Ω"
            echo "–û—Ç–≤–µ—Ç: $LONG_RESPONSE"
          fi
          
        else
          echo -e "\n‚ùå –û–®–ò–ë–ö–ê: Auth token –Ω–µ –ø–æ–ª—É—á–µ–Ω"
          echo "–ö–æ–¥ –æ—à–∏–±–∫–∏: $(echo "$RESPONSE" | grep -o '"result":[0-9]*')"
          
          # –ï—Å–ª–∏ 2000 - –ø—Ä–æ–±–ª–µ–º–∞ –≤ —É—á–µ—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
          if echo "$RESPONSE" | grep -q '"result":2000'; then
            echo ""
            echo "üîß –†–ï–®–ï–ù–ò–ï:"
            echo "1. –ü–æ–ª—É—á–∏—Ç–µ App Password –≤ pCloud"
            echo "2. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –µ–≥–æ –≤–º–µ—Å—Ç–æ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø–∞—Ä–æ–ª—è"
            echo "3. –ò–ª–∏ –≤—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–∏—Ç–µ 2FA"
          fi
        fi
