name: Get pCloud Token (Fully Encoded)

on:
  workflow_dispatch:

jobs:
  get-token:
    runs-on: ubuntu-latest
    
    steps:
    - name: Get Token with Full Encoding
      env:
        PCLOUD_EMAIL: ${{ secrets.PCLOUD_EMAIL }}
        PCLOUD_PASSWORD: ${{ secrets.PCLOUD_PASSWORD }}
      run: |
        echo "=== –ü–û–õ–ù–û–ï –ö–û–î–ò–†–û–í–ê–ù–ò–ï –í–°–ï–• –°–ò–ú–í–û–õ–û–í ==="
        
        # 1. –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        echo "üîç –ò—Å—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:"
        echo "Email: '$PCLOUD_EMAIL'"
        echo "–î–ª–∏–Ω–∞ email: ${#PCLOUD_EMAIL}"
        echo "–î–ª–∏–Ω–∞ –ø–∞—Ä–æ–ª—è: ${#PCLOUD_PASSWORD}"
        
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ–±–ª–µ–º–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã
        echo -e "\nüîç –ü–æ–∏—Å–∫ –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤:"
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º email
        echo "–í email –µ—Å—Ç—å:"
        [[ "$PCLOUD_EMAIL" == *@* ]] && echo "  @ (—Å–æ–±–∞–∫–∞) - –î–ê"
        [[ "$PCLOUD_EMAIL" == *.* ]] && echo "  . (—Ç–æ—á–∫–∞) - –î–ê"
        [[ "$PCLOUD_EMAIL" == *+* ]] && echo "  + (–ø–ª—é—Å) - –î–ê"
        [[ "$PCLOUD_EMAIL" == *=* ]] && echo "  = (—Ä–∞–≤–Ω–æ) - –î–ê"
        
        # 2. –ö–û–ú–ü–õ–ï–ö–°–ù–û–ï –ö–û–î–ò–†–û–í–ê–ù–ò–ï
        echo -e "\nüîß –ö–æ–º–ø–ª–µ–∫—Å–Ω–æ–µ –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ..."
        
        # –°–ø–æ—Å–æ–± 1: –ß–µ—Ä–µ–∑ Python (–Ω–∞–¥–µ–∂–Ω–µ–µ –≤—Å–µ–≥–æ)
        ENCODED_EMAIL=$(python3 << EOF
import urllib.parse
import sys
email = """$PCLOUD_EMAIL"""
# –ö–æ–¥–∏—Ä—É–µ–º –í–°–Å, –¥–∞–∂–µ –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã
encoded = urllib.parse.quote(email, safe='')
print(encoded)
EOF
        )
        
        ENCODED_PASSWORD=$(python3 << EOF
import urllib.parse
import sys
password = """$PCLOUD_PASSWORD"""
# –ö–æ–¥–∏—Ä—É–µ–º –í–°–Å –¥–ª—è –ø–∞—Ä–æ–ª—è
encoded = urllib.parse.quote(password, safe='')
print(encoded)
EOF
        )
        
        echo "Email –∑–∞–∫–æ–¥–∏—Ä–æ–≤–∞–Ω: $ENCODED_EMAIL"
        echo "–ü–∞—Ä–æ–ª—å –∑–∞–∫–æ–¥–∏—Ä–æ–≤–∞–Ω: ${ENCODED_PASSWORD:0:30}..."
        
        # 3. –û–¢–ü–†–ê–í–ö–ê –ó–ê–ü–†–û–°–ê
        echo -e "\nüì§ –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞..."
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞ –í–†–£–ß–ù–£–Æ —Å –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
        REQUEST_BODY="getauth=1&username=${ENCODED_EMAIL}&password=${ENCODED_PASSWORD}"
        
        echo "–¢–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞:"
        echo "getauth=1&username=${ENCODED_EMAIL:0:30}...&password=${ENCODED_PASSWORD:0:10}..."
        
        RESPONSE=$(curl -s -v -X POST \
          -H "Content-Type: application/x-www-form-urlencoded" \
          -d "$REQUEST_BODY" \
          https://api.pcloud.com/userinfo 2>&1)
        
        # –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–æ–ª—å–∫–æ JSON –æ—Ç–≤–µ—Ç
        JSON_RESPONSE=$(echo "$RESPONSE" | grep -A 100 "^{" | head -20)
        
        echo -e "\nüì• –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:"
        echo "$JSON_RESPONSE"
        
        # 4. –û–ë–†–ê–ë–û–¢–ö–ê –û–¢–í–ï–¢–ê
        AUTH_TOKEN=$(echo "$JSON_RESPONSE" | grep -o '"auth":"[^"]*"' | cut -d'"' -f4)
        
        if [ -n "$AUTH_TOKEN" ]; then
          echo -e "\n‚úÖ –£–°–ü–ï–•! Auth token –ø–æ–ª—É—á–µ–Ω: ${AUTH_TOKEN:0:20}..."
          
          # 5. –î–û–õ–ì–û–°–†–û–ß–ù–´–ô –¢–û–ö–ï–ù
          echo -e "\nüîÑ –°–æ–∑–¥–∞–µ–º –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã–π —Ç–æ–∫–µ–Ω..."
          
          LONG_RESPONSE=$(curl -s -X POST \
            "https://api.pcloud.com/gettoken?auth=$AUTH_TOKEN&expires=31536000&access=readwrite&appname=GitHub%20Actions")
          
          LONG_TOKEN=$(echo "$LONG_RESPONSE" | grep -o '"token":"[^"]*"' | cut -d'"' -f4)
          
          if [ -n "$LONG_TOKEN" ]; then
            echo -e "\nüéâ –î–û–õ–ì–û–°–†–û–ß–ù–´–ô –¢–û–ö–ï–ù –°–û–ó–î–ê–ù!"
            echo "=================================="
            echo "–¢–û–ö–ï–ù: $LONG_TOKEN"
            echo "=================================="
            echo ""
            echo "üí° –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –∫–∞–∫ PCLOUD_LONG_TOKEN –≤ GitHub Secrets"
          else
            echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã–π —Ç–æ–∫–µ–Ω"
          fi
          
        else
          echo -e "\n‚ùå –û–®–ò–ë–ö–ê: Auth token –Ω–µ –ø–æ–ª—É—á–µ–Ω"
          
          # –î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –æ—à–∏–±–∫–∏
          if echo "$JSON_RESPONSE" | grep -q '"result":2000'; then
            echo "   –ö–æ–¥ 2000: –ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω/–ø–∞—Ä–æ–ª—å"
            echo ""
            echo "üîß –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò:"
            echo "1. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ App Password –≤–º–µ—Å—Ç–æ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ"
            echo "2. –í—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–∏—Ç–µ 2FA"
            echo "3. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π –±—Ä–∞—É–∑–µ—Ä –¥–ª—è –≤—Ö–æ–¥–∞"
          fi
          
          # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ª–Ω—ã–π –æ—Ç–≤–µ—Ç –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
          echo -e "\nüîç –ü–æ–ª–Ω—ã–π –æ—Ç–≤–µ—Ç curl:"
          echo "$RESPONSE" | tail -50
        fi
