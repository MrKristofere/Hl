name: Debug pCloud Auth

on:
  workflow_dispatch:

jobs:
  debug:
    runs-on: ubuntu-latest
    
    steps:
    - name: Debug Authentication
      env:
        PCLOUD_EMAIL: ${{ secrets.PCLOUD_EMAIL }}
        PCLOUD_PASSWORD: ${{ secrets.PCLOUD_PASSWORD }}
      run: |
        echo "=== Ð”Ð˜ÐÐ“ÐÐžÐ¡Ð¢Ð˜ÐšÐ ÐÐ’Ð¢ÐžÐ Ð˜Ð—ÐÐ¦Ð˜Ð˜ ==="
        
        # ÐŸÐ¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ Ñ‡Ñ‚Ð¾ Ð² Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ñ… (Ð±ÐµÐ· Ð¿Ð°Ñ€Ð¾Ð»Ñ)
        echo "Email (Ð¿ÐµÑ€Ð²Ñ‹Ðµ 10 ÑÐ¸Ð¼Ð²Ð¾Ð»Ð¾Ð²): '${PCLOUD_EMAIL:0:10}'"
        echo "Ð”Ð»Ð¸Ð½Ð° email: ${#PCLOUD_EMAIL}"
        echo "Ð”Ð»Ð¸Ð½Ð° Ð¿Ð°Ñ€Ð¾Ð»Ñ: ${#PCLOUD_PASSWORD}"
        
        # Ð¢ÐµÑÑ‚ 1: ÐŸÑ€Ð¾ÑÑ‚Ð¾Ð¹ Ð·Ð°Ð¿Ñ€Ð¾Ñ
        echo -e "\nðŸ” Ð¢ÐµÑÑ‚ 1: ÐŸÑ€Ð¾ÑÑ‚Ð¾Ð¹ Ð·Ð°Ð¿Ñ€Ð¾Ñ"
        curl -s -X POST \
          -d "getauth=1&username=test@example.com&password=test123" \
          https://api.pcloud.com/userinfo | grep -o '"result":[0-9]*'
        
        # Ð¢ÐµÑÑ‚ 2: Ð¡ Ð½Ð°ÑˆÐ¸Ð¼Ð¸ Ð´Ð°Ð½Ð½Ñ‹Ð¼Ð¸ Ñ‡ÐµÑ€ÐµÐ· --data-urlencode
        echo -e "\nðŸ” Ð¢ÐµÑÑ‚ 2: Ð¡ Ð½Ð°ÑˆÐ¸Ð¼Ð¸ Ð´Ð°Ð½Ð½Ñ‹Ð¼Ð¸"
        curl -s -X POST \
          --data-urlencode "getauth=1" \
          --data-urlencode "username=$PCLOUD_EMAIL" \
          --data-urlencode "password=$PCLOUD_PASSWORD" \
          https://api.pcloud.com/userinfo
        
        # Ð¢ÐµÑÑ‚ 3: Ð¡ Ð·Ð°ÐºÐ¾Ð´Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ð¼Ð¸ Ð´Ð°Ð½Ð½Ñ‹Ð¼Ð¸
        echo -e "\nðŸ” Ð¢ÐµÑÑ‚ 3: Ð¡ ÐºÐ¾Ð´Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸ÐµÐ¼"
        
        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ñ„Ð°Ð¹Ð»Ñ‹ Ð´Ð»Ñ Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾Ð¹ Ð¿ÐµÑ€ÐµÐ´Ð°Ñ‡Ð¸
        cat > /tmp/email.txt << EOF
        $PCLOUD_EMAIL
        EOF
        
        cat > /tmp/password.txt << EOF
        $PCLOUD_PASSWORD
        EOF
        
        # ÐšÐ¾Ð´Ð¸Ñ€ÑƒÐµÐ¼ Ð¸Ð· Ñ„Ð°Ð¹Ð»Ð¾Ð²
        ENC_EMAIL=$(python3 -c "import urllib.parse; print(urllib.parse.quote(open('/tmp/email.txt').read().strip()))")
        ENC_PASS=$(python3 -c "import urllib.parse; print(urllib.parse.quote(open('/tmp/password.txt').read().strip()))")
        
        curl -s -X POST \
          -d "getauth=1&username=$ENC_EMAIL&password=$ENC_PASS" \
          https://api.pcloud.com/userinfo | grep -o '"result":[0-9]*\|"auth":"[^"]*"'
        
        # ÐžÑ‡Ð¸ÑÑ‚ÐºÐ°
        rm -f /tmp/email.txt /tmp/password.txt
