name: Get pCloud Token (Correct)

on:
  workflow_dispatch:

jobs:
  get-token:
    runs-on: ubuntu-latest
    
    steps:
    - name: Get pCloud Auth Token
      env:
        PCLOUD_EMAIL: ${{ secrets.PCLOUD_EMAIL }}
        PCLOUD_PASSWORD: ${{ secrets.PCLOUD_PASSWORD }}
      run: |
        echo "=== –ü–û–õ–£–ß–ï–ù–ò–ï –¢–û–ö–ï–ù–ê PCLOUD ==="
        
        # 1. –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ (–ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ —Å–∏–º–≤–æ–ª—ã)
        echo "üìß Email: '$PCLOUD_EMAIL'"
        echo "üìè –î–ª–∏–Ω–∞ email: ${#PCLOUD_EMAIL} —Å–∏–º–≤–æ–ª–æ–≤"
        echo "üîí –î–ª–∏–Ω–∞ –ø–∞—Ä–æ–ª—è: ${#PCLOUD_PASSWORD} —Å–∏–º–≤–æ–ª–æ–≤"
        
        # –ü–æ–∫–∞–∂–µ–º –ø–æ–±–∞–π—Ç–æ–≤–æ
        echo -n "üîç Email –≤ hex: "
        echo -n "$PCLOUD_EMAIL" | od -An -tx1 | tr -d '\n'
        echo ""
        
        # 2. –¢–µ—Å—Ç —Å –í–°–ï–ú–ò —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ –∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
        echo -e "\nüß™ –¢–µ—Å—Ç —Å –ø–æ–ª–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏:"
        
        # –°–æ–≥–ª–∞—Å–Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏:
        # - getauth=1 - –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞
        # - device - —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —É–∫–∞–∑–∞—Ç—å
        # - authexpire - –º–æ–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å —Å—Ä–æ–∫ (–≤ —Å–µ–∫—É–Ω–¥–∞—Ö)
        
        DEVICE_NAME="github-actions-$(date +%s)"
        
        RESPONSE=$(curl -s -X POST \
          --data-urlencode "getauth=1" \
          --data-urlencode "username=$PCLOUD_EMAIL" \
          --data-urlencode "password=$PCLOUD_PASSWORD" \
          --data-urlencode "device=$DEVICE_NAME" \
          --data-urlencode "authexpire=31536000" \  # 1 –≥–æ–¥
          --data-urlencode "authinactiveexpire=2678400" \  # 1 –º–µ—Å—è—Ü –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
          https://api.pcloud.com/userinfo)
        
        echo "–û—Ç–≤–µ—Ç: $RESPONSE"
        
        # 3. –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–æ–∫–µ–Ω
        AUTH_TOKEN=$(echo "$RESPONSE" | grep -o '"auth":"[^"]*"' | cut -d'"' -f4)
        
        if [ -n "$AUTH_TOKEN" ]; then
          echo -e "\n‚úÖ –£–°–ü–ï–•! Auth token –ø–æ–ª—É—á–µ–Ω"
          echo "–¢–æ–∫–µ–Ω: ${AUTH_TOKEN:0:20}..."
          echo "–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ: $DEVICE_NAME"
          
          # 4. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–∫–µ–Ω
          echo -e "\nüîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–∫–µ–Ω..."
          CHECK_RESPONSE=$(curl -s "https://api.pcloud.com/userinfo?auth=$AUTH_TOKEN")
          
          if echo "$CHECK_RESPONSE" | grep -q '"result":0'; then
            echo "‚úÖ –¢–æ–∫–µ–Ω —Ä–∞–±–æ—Ç–∞–µ—Ç!"
            
            # 5. –°–æ–∑–¥–∞–µ–º –î–û–õ–ì–û–°–†–û–ß–ù–´–ô —Ç–æ–∫–µ–Ω —á–µ—Ä–µ–∑ gettoken
            echo -e "\nüîÑ –°–æ–∑–¥–∞–µ–º –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã–π —Ç–æ–∫–µ–Ω..."
            LONG_RESPONSE=$(curl -s -X POST \
              "https://api.pcloud.com/gettoken?auth=$AUTH_TOKEN&expires=31536000&access=readwrite&appname=GitHub%20Actions")
            
            echo "–û—Ç–≤–µ—Ç gettoken: $LONG_RESPONSE"
            
            LONG_TOKEN=$(echo "$LONG_RESPONSE" | grep -o '"token":"[^"]*"' | cut -d'"' -f4)
            
            if [ -n "$LONG_TOKEN" ]; then
              echo -e "\nüéâ –î–û–õ–ì–û–°–†–û–ß–ù–´–ô –¢–û–ö–ï–ù –°–û–ó–î–ê–ù!"
              echo "================================"
              echo "$LONG_TOKEN"
              echo "================================"
              echo ""
              echo "üí° –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –∫–∞–∫ PCLOUD_LONG_TOKEN –≤ GitHub Secrets"
            else
              echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã–π —Ç–æ–∫–µ–Ω"
            fi
            
          else
            echo "‚ùå –¢–æ–∫–µ–Ω –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç"
          fi
          
        else
          echo -e "\n‚ùå –û–®–ò–ë–ö–ê: Auth token –Ω–µ –ø–æ–ª—É—á–µ–Ω"
          
          # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –æ—à–∏–±–∫—É
          if echo "$RESPONSE" | grep -q '"result":2000'; then
            echo "   –ö–æ–¥ 2000: Log in failed"
            echo ""
            echo "üîß –í–û–ó–ú–û–ñ–ù–´–ï –ü–†–ò–ß–ò–ù–´:"
            echo "1. –ù–µ–≤–µ—Ä–Ω—ã–π email –∏–ª–∏ –ø–∞—Ä–æ–ª—å"
            echo "2. –í–∫–ª—é—á–µ–Ω–∞ 2FA (–Ω—É–∂–µ–Ω –∫–æ–¥ –∏–∑ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è)"
            echo "3. –ê–∫–∫–∞—É–Ω—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω"
            echo ""
            echo "üõ†Ô∏è  –†–ï–®–ï–ù–ò–ï:"
            echo "1. –í–æ–π–¥–∏—Ç–µ –Ω–∞ https://my.pcloud.com"
            echo "2. –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –ø–∞—Ä–æ–ª—å –≤–µ—Ä–Ω—ã–π"
            echo "3. –û—Ç–∫–ª—é—á–∏—Ç–µ 2FA –∏–ª–∏ –ø–æ–ª—É—á–∏—Ç–µ App Password"
          fi
        fi
