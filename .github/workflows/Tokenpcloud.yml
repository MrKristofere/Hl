name: Get pCloud Token (Fixed for @ symbol)

on:
  workflow_dispatch:

jobs:
  get-token:
    runs-on: ubuntu-latest
    
    steps:
    - name: Get Long-term Token
      env:
        PCLOUD_EMAIL: ${{ secrets.PCLOUD_EMAIL }}
        PCLOUD_PASSWORD: ${{ secrets.PCLOUD_PASSWORD }}
      run: |
        echo "üîß –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞:"
        echo "Email: $PCLOUD_EMAIL"
        echo "–ü–∞—Ä–æ–ª—å (–¥–ª–∏–Ω–∞): ${#PCLOUD_PASSWORD} —Å–∏–º–≤–æ–ª–æ–≤"
        
        # ===== 1. –ü–û–õ–£–ß–ê–ï–ú –í–†–ï–ú–ï–ù–ù–´–ô –¢–û–ö–ï–ù (–° –ö–û–î–ò–†–û–í–ê–ù–ò–ï–ú) =====
        echo -e "\nüì§ –ü–æ–ª—É—á–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ç–æ–∫–µ–Ω..."
        
        # –ö–æ–¥–∏—Ä—É–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã –≤ email –∏ –ø–∞—Ä–æ–ª–µ
        ENCODED_EMAIL=$(printf '%s' "$PCLOUD_EMAIL" | jq -sRr @uri)
        ENCODED_PASSWORD=$(printf '%s' "$PCLOUD_PASSWORD" | jq -sRr @uri)
        
        # –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ —á–µ—Ä–µ–∑ Python –µ—Å–ª–∏ jq –Ω–µ—Ç
        if [ -z "$ENCODED_EMAIL" ]; then
          ENCODED_EMAIL=$(python3 -c "import urllib.parse; print(urllib.parse.quote('$PCLOUD_EMAIL'))")
          ENCODED_PASSWORD=$(python3 -c "import urllib.parse; print(urllib.parse.quote('$PCLOUD_PASSWORD'))")
        fi
        
        echo "–ó–∞–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã–π email: $ENCODED_EMAIL"
        
        RESPONSE=$(curl -s -w "\nHTTP_STATUS:%{http_code}" -X POST \
          -d "getauth=1&username=$ENCODED_EMAIL&password=$ENCODED_PASSWORD" \
          https://api.pcloud.com/userinfo)
        
        # –†–∞–∑–¥–µ–ª—è–µ–º JSON –∏ —Å—Ç–∞—Ç—É—Å
        HTTP_STATUS=$(echo "$RESPONSE" | grep "HTTP_STATUS:" | cut -d':' -f2)
        JSON_RESPONSE=$(echo "$RESPONSE" | sed '/HTTP_STATUS:/d')
        
        echo "HTTP —Å—Ç–∞—Ç—É—Å: $HTTP_STATUS"
        echo "–û—Ç–≤–µ—Ç API: $JSON_RESPONSE"
        
        # –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–æ–∫–µ–Ω
        AUTH_TOKEN=$(echo "$JSON_RESPONSE" | grep -o '"auth":"[^"]*"' | cut -d'"' -f4)
        
        if [ -z "$AUTH_TOKEN" ]; then
          echo -e "\n‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å auth token"
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –æ—à–∏–±–∫—É
          if echo "$JSON_RESPONSE" | grep -q '"result":2000'; then
            echo "–û–®–ò–ë–ö–ê 2000: –ù–µ–≤–µ—Ä–Ω—ã–µ —É—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ"
            echo "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ:"
            echo "1. Email —Ç–æ—á–Ω–æ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π: $PCLOUD_EMAIL"
            echo "2. –ü–∞—Ä–æ–ª—å —Ç–æ—á–Ω–æ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π"
            echo "3. –ê–∫–∫–∞—É–Ω—Ç –Ω–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω"
          fi
          
          exit 1
        fi
        
        echo -e "\n‚úÖ –í—Ä–µ–º–µ–Ω–Ω—ã–π —Ç–æ–∫–µ–Ω –ø–æ–ª—É—á–µ–Ω: ${AUTH_TOKEN:0:20}..."
        
        # ===== 2. –°–û–ó–î–ê–ï–ú –î–û–õ–ì–û–°–†–û–ß–ù–´–ô –¢–û–ö–ï–ù =====
        echo -e "\nüîÑ –°–æ–∑–¥–∞–µ–º –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã–π —Ç–æ–∫–µ–Ω (1 –≥–æ–¥)..."
        
        LONG_TERM_RESPONSE=$(curl -s -X POST \
          "https://api.pcloud.com/gettoken?auth=$AUTH_TOKEN&expires=31536000&access=readwrite&appname=GitHub%20Actions")
        
        echo "–û—Ç–≤–µ—Ç gettoken: $LONG_TERM_RESPONSE"
        
        LONG_TERM_TOKEN=$(echo "$LONG_TERM_RESPONSE" | grep -o '"token":"[^"]*"' | cut -d'"' -f4)
        
        if [ -z "$LONG_TERM_TOKEN" ]; then
          echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã–π —Ç–æ–∫–µ–Ω"
          exit 1
        fi
        
        # ===== 3. –í–´–í–û–î –†–ï–ó–£–õ–¨–¢–ê–¢–ê =====
        echo -e "\nüéâ ================================="
        echo "‚úÖ –î–û–õ–ì–û–°–†–û–ß–ù–´–ô –¢–û–ö–ï–ù –°–û–ó–î–ê–ù!"
        echo "================================"
        echo ""
        echo "–¢–û–ö–ï–ù: $LONG_TERM_TOKEN"
        echo ""
        echo "üîß –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:"
        echo "1. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Ç–æ–∫–µ–Ω –≤—ã—à–µ"
        echo "2. –í GitHub: Settings ‚Üí Secrets ‚Üí Actions"
        echo "3. –°–æ–∑–¥–∞–π—Ç–µ —Å–µ–∫—Ä–µ—Ç: PCLOUD_LONG_TOKEN"
        echo "4. –ó–Ω–∞—á–µ–Ω–∏–µ: —ç—Ç–æ—Ç —Ç–æ–∫–µ–Ω"
        echo ""
        echo "üìù –ü—Ä–∏–º–µ—Ä —Å–∫—Ä–∏–ø—Ç–∞:"
        echo 'curl -X POST \'
        echo '  "https://api.pcloud.com/downloadfile?auth=–¢–í–û–ô_–¢–û–ö–ï–ù&folderid=0&url=URL"'
        echo -e "\n‚úÖ –ì–æ—Ç–æ–≤–æ!"
