name: Get pCloud Long-term Token

on:
  workflow_dispatch:  # –¢–æ–ª—å–∫–æ —Ä—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫

jobs:
  get-token:
    runs-on: ubuntu-latest
    
    steps:
    - name: Generate Long-term pCloud Token
      env:
        PCLOUD_EMAIL: ${{ secrets.PCLOUD_EMAIL }}
        PCLOUD_PASSWORD: ${{ secrets.PCLOUD_PASSWORD }}
      run: |
        echo "=== –ü–û–õ–£–ß–ï–ù–ò–ï –î–û–õ–ì–û–°–†–û–ß–ù–û–ì–û –¢–û–ö–ï–ù–ê PCLOUD ==="
        echo "–¢–æ–∫–µ–Ω –±—É–¥–µ—Ç –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω 1 –ì–û–î (31536000 —Å–µ–∫—É–Ω–¥)"
        echo ""
        
        # ===== 1. –ü–û–õ–£–ß–ê–ï–ú –í–†–ï–ú–ï–ù–ù–´–ô –¢–û–ö–ï–ù =====
        echo "üîê –®–∞–≥ 1: –ü–æ–ª—É—á–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ç–æ–∫–µ–Ω..."
        
        TEMP_RESPONSE=$(curl -s -X POST \
          -d "getauth=1&username=$PCLOUD_EMAIL&password=$PCLOUD_PASSWORD" \
          https://api.pcloud.com/userinfo)
        
        echo "–û—Ç–≤–µ—Ç: $TEMP_RESPONSE"
        
        TEMP_TOKEN=$(echo "$TEMP_RESPONSE" | grep -o '"auth":"[^"]*"' | cut -d'"' -f4)
        
        if [ -z "$TEMP_TOKEN" ]; then
          echo "‚ùå –û–®–ò–ë–ö–ê: –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ç–æ–∫–µ–Ω"
          
          if echo "$TEMP_RESPONSE" | grep -q '"tfa_required":true'; then
            echo ""
            echo "‚ö†Ô∏è  –í–∫–ª—é—á–µ–Ω–∞ –¥–≤—É—Ö—Ñ–∞–∫—Ç–æ—Ä–Ω–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è (2FA)"
            echo "–î–æ–±–∞–≤—å—Ç–µ —ç—Ç–æ—Ç —à–∞–≥ –≤ –Ω–∞—á–∞–ª–æ —Å–∫—Ä–∏–ø—Ç–∞:"
            echo ""
            echo "1. –ü–æ–ª—É—á–∏—Ç–µ tfauth:"
            echo "   curl -d 'getauth=1&username=EMAIL&password=PASSWORD' \\"
            echo "     https://api.pcloud.com/userinfo"
            echo ""
            echo "2. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–¥ 2FA:"
            echo "   curl -d 'tfauth=TFAUTH_VALUE&totp=–ö–û–î_–ò–ó_–ü–†–ò–õ–û–ñ–ï–ù–ò–Ø' \\"
            echo "     https://api.pcloud.com/userinfo"
          fi
          
          exit 1
        fi
        
        echo "‚úÖ –í—Ä–µ–º–µ–Ω–Ω—ã–π —Ç–æ–∫–µ–Ω –ø–æ–ª—É—á–µ–Ω: ${TEMP_TOKEN:0:15}..."
        
        # ===== 2. –°–û–ó–î–ê–ï–ú –î–û–õ–ì–û–°–†–û–ß–ù–´–ô –¢–û–ö–ï–ù =====
        echo ""
        echo "üîê –®–∞–≥ 2: –°–æ–∑–¥–∞–µ–º –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã–π —Ç–æ–∫–µ–Ω (1 –≥–æ–¥)..."
        
        # –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Ç–æ–∫–µ–Ω–∞:
        # - expires: —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è –≤ —Å–µ–∫—É–Ω–¥–∞—Ö (31536000 = 1 –≥–æ–¥)
        # - access: –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ (readwrite = —á—Ç–µ–Ω–∏–µ+–∑–∞–ø–∏—Å—å)
        # - appname: –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (–±—É–¥–µ—Ç –≤–∏–¥–Ω–æ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö)
        
        LONG_TERM_RESPONSE=$(curl -s -X POST \
          "https://api.pcloud.com/gettoken?auth=$TEMP_TOKEN&expires=31536000&access=readwrite&appname=GitHub%20Actions%20Uploader")
        
        echo "–û—Ç–≤–µ—Ç: $LONG_TERM_RESPONSE"
        
        # ===== 3. –ò–ó–í–õ–ï–ö–ê–ï–ú –î–û–õ–ì–û–°–†–û–ß–ù–´–ô –¢–û–ö–ï–ù =====
        LONG_TERM_TOKEN=$(echo "$LONG_TERM_RESPONSE" | grep -o '"token":"[^"]*"' | cut -d'"' -f4)
        
        if [ -z "$LONG_TERM_TOKEN" ]; then
          echo "‚ùå –û–®–ò–ë–ö–ê: –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã–π —Ç–æ–∫–µ–Ω"
          exit 1
        fi
        
        # ===== 4. –í–´–í–û–î –ò–ù–§–û–†–ú–ê–¶–ò–ò =====
        echo ""
        echo "üéâ =========================================="
        echo "‚úÖ –î–û–õ–ì–û–°–†–û–ß–ù–´–ô –¢–û–ö–ï–ù –£–°–ü–ï–®–ù–û –°–û–ó–î–ê–ù!"
        echo "=========================================="
        echo ""
        echo "üìã –ò–ù–§–û–†–ú–ê–¶–ò–Ø –û –¢–û–ö–ï–ù–ï:"
        echo "   –¢–æ–∫–µ–Ω: $LONG_TERM_TOKEN"
        echo "   –¢–∏–ø: –î–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã–π (Long-term)"
        echo "   –°—Ä–æ–∫: 1 –≥–æ–¥ —Å –º–æ–º–µ–Ω—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è"
        echo "   –ü—Ä–∞–≤–∞: –ß—Ç–µ–Ω–∏–µ –∏ –∑–∞–ø–∏—Å—å (readwrite)"
        echo "   –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ: GitHub Actions Uploader"
        echo ""
        echo "üîß –ö–ê–ö –ò–°–ü–û–õ–¨–ó–û–í–ê–¢–¨:"
        echo "1. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Ç–æ–∫–µ–Ω –≤—ã—à–µ"
        echo "2. –í —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ GitHub:"
        echo "   Settings ‚Üí Secrets and variables ‚Üí Actions"
        echo "3. –°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π —Å–µ–∫—Ä–µ—Ç:"
        echo "   Name: PCLOUD_LONG_TOKEN"
        echo "   Value: $LONG_TERM_TOKEN"
        echo ""
        echo "üìù –ü–†–ò–ú–ï–† –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–Ø –í WORKFLOW:"
        echo "  - name: Upload to pCloud"
        echo "    env:"
        echo "      PCLOUD_TOKEN: \${{ secrets.PCLOUD_LONG_TOKEN }}"
        echo "    run: |"
        echo "      curl -X POST \\"
        echo "        \"https://api.pcloud.com/downloadfile?auth=\$PCLOUD_TOKEN&folderid=0&url=FILE_URL\""
        echo ""
        echo "‚ö†Ô∏è  –í–ê–ñ–ù–û:"
        echo "‚Ä¢ –¢–æ–∫–µ–Ω –≤–∏–¥–µ–Ω —Ç–æ–ª—å–∫–æ —Å–µ–π—á–∞—Å!"
        echo "‚Ä¢ –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –µ–≥–æ –≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ–º –º–µ—Å—Ç–µ"
        echo "‚Ä¢ –î–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –Ω—É–∂–Ω–æ –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–≤—ã–π"
        echo "‚Ä¢ –£–ø—Ä–∞–≤–ª—è—Ç—å —Ç–æ–∫–µ–Ω–∞–º–∏: https://my.pcloud.com/#settings"
        echo ""
        echo "üéØ =========================================="
        
        # ===== 5. –ü–†–û–í–ï–†–ö–ê –¢–û–ö–ï–ù–ê =====
        echo ""
        echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–∫–µ–Ω..."
        
        CHECK_RESPONSE=$(curl -s "https://api.pcloud.com/userinfo?auth=$LONG_TERM_TOKEN")
        
        if echo "$CHECK_RESPONSE" | grep -q '"result":0'; then
          EMAIL=$(echo "$CHECK_RESPONSE" | grep -o '"email":"[^"]*"' | cut -d'"' -f4)
          QUOTA=$(echo "$CHECK_RESPONSE" | grep -o '"quota":[0-9]*' | cut -d':' -f2)
          QUOTA_GB=$((QUOTA / 1073741824))
          USED=$(echo "$CHECK_RESPONSE" | grep -o '"usedquota":[0-9]*' | cut -d':' -f2)
          USED_GB=$((USED / 1073741824))
          
          echo "‚úÖ –¢–æ–∫–µ–Ω —Ä–∞–±–æ—Ç–∞–µ—Ç!"
          echo "   –ê–∫–∫–∞—É–Ω—Ç: $EMAIL"
          echo "   –ö–≤–æ—Ç–∞: ${QUOTA_GB} GB"
          echo "   –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ: ${USED_GB} GB"
        else
          echo "‚ö†Ô∏è  –¢–æ–∫–µ–Ω —Å–æ–∑–¥–∞–Ω, –Ω–æ –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ —É–¥–∞–ª–∞—Å—å"
        fi
