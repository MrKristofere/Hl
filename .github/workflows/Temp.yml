name: Download and Process Archive

on:
  workflow_dispatch:
    inputs:
      file_url:
        description: 'URL of the archive file (.zip, .rar, .7z)'
        required: true

permissions:
  contents: write  # Grant write permissions for creating releases

jobs:
  download_and_process:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install aria2
        run: |
          sudo apt-get update
          sudo apt-get install -y aria2

      - name: Download file using aria2
        run: |
          aria2c -c -x 16 -s 16 -o archive.zip ${{ github.event.inputs.file_url }}

      - name: Extract ISO from archive
        run: |
          mkdir extracted
          if [[ ${{ github.event.inputs.file_url }} == *.zip ]]; then
            unzip archive.zip -d extracted
          elif [[ ${{ github.event.inputs.file_url }} == *.rar ]]; then
            sudo apt-get install unrar
            unrar x archive.zip extracted/
          elif [[ ${{ github.event.inputs.file_url }} == *.7z ]]; then
            sudo apt-get install p7zip-full
            7z x archive.zip -oextracted
          fi

      - name: Mount ISO
        run: |
          mkdir /mnt/iso
          sudo mount -o loop extracted/*.iso /mnt/iso

      - name: List files in ISO using find
        run: |
          find /mnt/iso -type f

      - name: Extract DLL and EMU files
        run: |
          find /mnt/iso -type f \( -name "*.dll" -o -name "*.emu" \) -exec cp {} ./extracted/ \;

      - name: Create Release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          tag_name: 'v1.0.0'  # Replace with dynamic versioning as needed
          files: './extracted/*'
          body_path: CHANGELOG.md  # Optional, if you have a changelog file
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
