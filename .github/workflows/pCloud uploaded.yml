name: Simple pCloud Upload

on:
  workflow_dispatch:
    inputs:
      file_url:
        description: 'URL файла'
        required: true
        type: string

jobs:
  upload:
    runs-on: ubuntu-latest
    
    steps:
    - name: Upload file to pCloud
      env:
        PCLOUD_EMAIL: ${{ secrets.PCLOUD_EMAIL }}
        PCLOUD_PASSWORD: ${{ secrets.PCLOUD_PASSWORD }}
      run: |
        # 1. Просто получаем auth токен
        echo "Получаем токен..."
        RESPONSE=$(curl -s -X POST \
          -d "getauth=1&username=$PCLOUD_EMAIL&password=$PCLOUD_PASSWORD" \
          https://api.pcloud.com/userinfo)
        
        echo "Ответ: $RESPONSE"
        
        # 2. Извлекаем токен
        AUTH_TOKEN=$(echo "$RESPONSE" | grep -o '"auth":"[^"]*"' | cut -d'"' -f4)
        
        if [ -z "$AUTH_TOKEN" ]; then
          echo "❌ Нет токена. Проверьте email/пароль"
          exit 1
        fi
        
        echo "✅ Токен получен!"
        
        # 3. Загружаем файл по URL
        curl -X POST \
          "https://api.pcloud.com/downloadfile?auth=$AUTH_TOKEN&folderid=0&url=${{ github.event.inputs.file_url }}&device=github-actions"
        
        echo "✅ Файл отправлен в очередь загрузки!"
