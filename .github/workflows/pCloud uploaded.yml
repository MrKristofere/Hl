name: Upload to pCloud via URL

on:
  workflow_dispatch:
    inputs:
      file_url:
        description: 'URL —Ñ–∞–π–ª–∞ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏'
        required: true
        type: string

jobs:
  upload:
    runs-on: ubuntu-latest
    
    steps:
    - name: Upload file to pCloud
      env:
        PCLOUD_EMAIL: ${{ secrets.PCLOUD_EMAIL }}
        PCLOUD_PASSWORD: ${{ secrets.PCLOUD_PASSWORD }}
      run: |
        echo "=== –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø –í PCLOUD ==="
        
        # ===== 1. –ü–û–õ–£–ß–ê–ï–ú AUTH TOKEN (–í–ê–ñ–ù–û: getauth=1) =====
        echo "üîê –ü–æ–ª—É—á–∞–µ–º auth token —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º getauth=1..."
        
        AUTH_RESPONSE=$(curl -s -X POST \
          -d "getauth=1&username=$PCLOUD_EMAIL&password=$PCLOUD_PASSWORD" \
          https://api.pcloud.com/userinfo)
        
        echo "–û—Ç–≤–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: $AUTH_RESPONSE"
        
        # ===== 2. –ò–ó–í–õ–ï–ö–ê–ï–ú –¢–û–ö–ï–ù =====
        AUTH_TOKEN=$(echo "$AUTH_RESPONSE" | grep -o '"auth":"[^"]*"' | cut -d'"' -f4)
        
        if [ -z "$AUTH_TOKEN" ]; then
          echo "‚ùå –û–®–ò–ë–ö–ê: –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å auth token"
          
          # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –æ—à–∏–±–∫—É
          if echo "$AUTH_RESPONSE" | grep -q '"result":2000'; then
            echo "   –ü–†–ò–ß–ò–ù–ê: –ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å"
            echo "   –ü—Ä–æ–≤–µ—Ä—å—Ç–µ secrets PCLOUD_EMAIL –∏ PCLOUD_PASSWORD"
          elif echo "$AUTH_RESPONSE" | grep -q '"tfa_required":true'; then
            echo "   –ü–†–ò–ß–ò–ù–ê: –í–∫–ª—é—á–µ–Ω–∞ –¥–≤—É—Ö—Ñ–∞–∫—Ç–æ—Ä–Ω–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è"
            echo "   –†–µ—à–µ–Ω–∏–µ: —Å–º. –≤–∞—Ä–∏–∞–Ω—Ç —Å 2FA –Ω–∏–∂–µ"
          fi
          
          exit 1
        fi
        
        echo "‚úÖ –ü–æ–ª—É—á–µ–Ω —Ç–æ–∫–µ–Ω: ${AUTH_TOKEN:0:15}..."
        
        # ===== 3. –ó–ê–ì–†–£–ó–ö–ê –§–ê–ô–õ–ê –ü–û –°–°–´–õ–ö–ï =====
        FILE_URL="${{ github.event.inputs.file_url }}"
        
        # device - —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∑–∞–ø—É—Å–∫–∞
        DEVICE="github-actions-${{ github.run_id }}"
        
        echo "üì§ –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–∞–π–ª: $FILE_URL"
        echo "   –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ: $DEVICE"
        
        UPLOAD_RESPONSE=$(curl -s -X POST \
          "https://api.pcloud.com/downloadfile?auth=$AUTH_TOKEN&folderid=0&url=$FILE_URL&device=$DEVICE")
        
        echo "–û—Ç–≤–µ—Ç –∑–∞–≥—Ä—É–∑–∫–∏: $UPLOAD_RESPONSE"
        
        # ===== 4. –ü–†–û–í–ï–†–ö–ê –†–ï–ó–£–õ–¨–¢–ê–¢–ê =====
        if echo "$UPLOAD_RESPONSE" | grep -q '"result":0'; then
          echo -e "\n‚úÖ –§–ê–ô–õ –£–°–ü–ï–®–ù–û –î–û–ë–ê–í–õ–ï–ù –í –û–ß–ï–†–ï–î–¨!"
          
          # –ò–∑–≤–ª–µ–∫–∞–µ–º ID —Ñ–∞–π–ª–∞
          FILE_ID=$(echo "$UPLOAD_RESPONSE" | \
            grep -o '"metadata":{[^}]*"fileid":[0-9]*' | \
            grep -o 'fileid":[0-9]*' | cut -d':' -f2)
          
          # –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –º–µ—Ç–æ–¥ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è
          if [ -z "$FILE_ID" ]; then
            FILE_ID=$(echo "$UPLOAD_RESPONSE" | grep -o '"fileid":[0-9]*' | head -1 | cut -d':' -f2)
          fi
          
          echo "üìä –î–µ—Ç–∞–ª–∏:"
          echo "   ID —Ñ–∞–π–ª–∞: $FILE_ID"
          echo "   –°—Å—ã–ª–∫–∞:   https://my.pcloud.com/#page=file&id=$FILE_ID"
          echo "   –ü—Ä–æ–≤–µ—Ä–∫–∞: https://api.pcloud.com/checksumfile?auth=$AUTH_TOKEN&fileid=$FILE_ID"
          
        else
          echo -e "\n‚ùå –û–®–ò–ë–ö–ê –ó–ê–ì–†–£–ó–ö–ò"
          
          if echo "$UPLOAD_RESPONSE" | grep -q '"result":2005'; then
            echo "   –ü–†–ò–ß–ò–ù–ê: –ù–µ–≤–µ—Ä–Ω—ã–π URL –∏–ª–∏ —Ñ–∞–π–ª –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
            echo "   –ü—Ä–æ–≤–µ—Ä—å—Ç–µ: $FILE_URL"
          elif echo "$UPLOAD_RESPONSE" | grep -q '"result":2009'; then
            echo "   –ü–†–ò–ß–ò–ù–ê: –ü—Ä–æ–±–ª–µ–º–∞ —Å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ–º (device)"
          fi
          
          exit 1
        fi
