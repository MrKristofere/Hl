name: Upload to pCloud via URL

on:
  workflow_dispatch:
    inputs:
      file_url:
        description: 'URL —Ñ–∞–π–ª–∞ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏'
        required: true
        type: string

jobs:
  upload:
    runs-on: ubuntu-latest
    
    steps:
    - name: Upload file to pCloud
      env:
        PCLOUD_EMAIL: ${{ secrets.PCLOUD_EMAIL }}
        PCLOUD_PASSWORD: ${{ secrets.PCLOUD_PASSWORD }}
      run: |
        echo "=== –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø –ò –ó–ê–ì–†–£–ó–ö–ê –í PCLOUD ==="
        
        # ===== 1. –ü–û–õ–£–ß–ï–ù–ò–ï –ê–ö–¢–£–ê–õ–¨–ù–û–ì–û –¢–û–ö–ï–ù–ê =====
        echo "üîê –ü–æ–ª—É—á–∞–µ–º —Å–≤–µ–∂–∏–π auth token..."
        
        AUTH_RESPONSE=$(curl -s -X POST \
          -d "username=$PCLOUD_EMAIL&password=$PCLOUD_PASSWORD" \
          https://api.pcloud.com/userinfo)
        
        echo "–û—Ç–≤–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: $AUTH_RESPONSE"
        
        # –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–æ–∫–µ–Ω –∏–∑ –æ—Ç–≤–µ—Ç–∞
        AUTH_TOKEN=$(echo "$AUTH_RESPONSE" | grep -o '"auth":"[^"]*"' | cut -d'"' -f4)
        
        if [ -z "$AUTH_TOKEN" ]; then
          echo "‚ùå –û–®–ò–ë–ö–ê: –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å auth token"
          echo "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å –≤ secrets"
          exit 1
        fi
        
        echo "‚úÖ –ü–æ–ª—É—á–µ–Ω —Ç–æ–∫–µ–Ω: ${AUTH_TOKEN:0:15}..."
        
        # ===== 2. –ù–ê–°–¢–†–û–ô–ö–ê –ü–ê–†–ê–ú–ï–¢–†–û–í =====
        FILE_URL="${{ github.event.inputs.file_url }}"
        FOLDER_ID="0"  # 0 = –∫–æ—Ä–Ω–µ–≤–∞—è –ø–∞–ø–∫–∞
        
        # device - —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –¥–ª—è —ç—Ç–æ–≥–æ –∑–∞–ø—É—Å–∫–∞
        DEVICE="github-actions-${{ github.run_id }}"
        
        # –ö–æ–¥–∏—Ä—É–µ–º URL
        ENCODED_URL=$(python3 -c "import urllib.parse; print(urllib.parse.quote('$FILE_URL'))")
        
        echo "üì¶ –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:"
        echo "   –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ: $DEVICE"
        echo "   URL —Ñ–∞–π–ª–∞: $FILE_URL"
        echo "   –ü–∞–ø–∫–∞ ID: $FOLDER_ID"
        
        # ===== 3. –ó–ê–ì–†–£–ó–ö–ê –§–ê–ô–õ–ê –ü–û –°–°–´–õ–ö–ï =====
        echo -e "\nüì§ –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–∞–π–ª –≤ pCloud..."
        
        UPLOAD_RESPONSE=$(curl -s -X POST \
          "https://api.pcloud.com/downloadfile?auth=$AUTH_TOKEN&folderid=$FOLDER_ID&url=$ENCODED_URL&device=$DEVICE")
        
        echo "–û—Ç–≤–µ—Ç –∑–∞–≥—Ä—É–∑–∫–∏: $UPLOAD_RESPONSE"
        
        # ===== 4. –û–ë–†–ê–ë–û–¢–ö–ê –û–¢–í–ï–¢–ê =====
        if echo "$UPLOAD_RESPONSE" | grep -q '"result":0'; then
          echo -e "\n‚úÖ –£–°–ü–ï–•! –§–∞–π–ª –ø–æ—Å—Ç–∞–≤–ª–µ–Ω –≤ –æ—á–µ—Ä–µ–¥—å –∑–∞–≥—Ä—É–∑–∫–∏"
          
          # –ò–∑–≤–ª–µ–∫–∞–µ–º ID —Ñ–∞–π–ª–∞ (—Ä–∞–∑–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –Ω–∞ —Å–ª—É—á–∞–π –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ñ–æ—Ä–º–∞—Ç–∞)
          FILE_ID=$(echo "$UPLOAD_RESPONSE" | \
            grep -o '"fileid":[0-9]*' | head -1 | cut -d':' -f2)
          
          if [ -z "$FILE_ID" ]; then
            FILE_ID=$(echo "$UPLOAD_RESPONSE" | \
              grep -o '"metadata":{[^}]*"fileid":[0-9]*' | \
              grep -o '"fileid":[0-9]*' | cut -d':' -f2)
          fi
          
          echo "üìä –î–µ—Ç–∞–ª–∏:"
          echo "   ID —Ñ–∞–π–ª–∞: $FILE_ID"
          echo "   –°—Å—ã–ª–∫–∞:   https://my.pcloud.com/#page=file&id=$FILE_ID"
          
          # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ outputs
          echo "pcloud_file_id=$FILE_ID" >> $GITHUB_OUTPUT
          
        else
          echo -e "\n‚ùå –û–®–ò–ë–ö–ê –ó–ê–ì–†–£–ó–ö–ò"
          echo "   –û—Ç–≤–µ—Ç API: $UPLOAD_RESPONSE"
          
          # –†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞ –æ—à–∏–±–æ–∫
          if echo "$UPLOAD_RESPONSE" | grep -q '"result":2005'; then
            echo "   –ü–†–ò–ß–ò–ù–ê: –ù–µ–≤–µ—Ä–Ω—ã–π URL –∏–ª–∏ —Ñ–∞–π–ª –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
          elif echo "$UPLOAD_RESPONSE" | grep -q '"result":2003'; then
            echo "   –ü–†–ò–ß–ò–ù–ê: –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–µ—Å—Ç–∞ –≤ pCloud"
          fi
          
          exit 1
        fi
    
    outputs:
      pcloud_file_id: ${{ steps.upload.outputs.pcloud_file_id }}
